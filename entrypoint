#!/usr/bin/env bash

set -eo pipefail

set -x

################################################################################
# Validate Inputs
################################################################################

function usage {
    echo "usage: $0 [name]"
    echo "  name         name of the app (eg. Broadband Plans)"
    exit 1
}

[ -z "$1" ] && { usage; }

################################################################################
# Set Inputs
################################################################################

NAME="$1"

################################################################################
# Extract Variables from GitHub Event Context
################################################################################

APP="$(jq --raw-output '.repository.name' "$GITHUB_EVENT_PATH")"

DEPLOYMENT_ENVIRONMENT="$(jq --raw-output '.deployment.environment' "$GITHUB_EVENT_PATH")"

if [[ "$DEPLOYMENT_ENVIRONMENT" == "production" ]]; then
  ENVIRONMENT="production"
  NAMESPACE="production"
else
  ENVIRONMENT="$(echo "$DEPLOYMENT_ENVIRONMENT" | cut -d/ -f1)"
  NAMESPACE="$(echo "$DEPLOYMENT_ENVIRONMENT" | cut -d/ -f2)"
fi

DEPLOYMENT_SHA="$(jq --raw-output '.deployment.sha' "$GITHUB_EVENT_PATH")"
TAG="${DEPLOYMENT_SHA::7}"

################################################################################
# Set Path
################################################################################

export PATH="$PATH:/bin"

################################################################################
# Login to GitHub Container Registry
################################################################################

echo "$INPUT_GITHUB_CONTAINER_REGISTRY_TOKEN" | docker login ghcr.io -u switcher-ie-deploy --password-stdin

################################################################################
# Login to ECR
################################################################################

$(aws ecr get-login --no-include-email)

################################################################################
# Promote
################################################################################

promote "${APP}" "${ENVIRONMENT}" "${NAMESPACE}" "${TAG}"

################################################################################
# Notify Slack
################################################################################

slack "${SLACK_WEBHOOK}" "development" "${NAME}" "$GITHUB_SHA" "https://github.com/$GITHUB_REPOSITORY/commit/$GITHUB_SHA" "${TAG}" "${NAMESPACE}"
