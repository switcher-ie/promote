#!/usr/bin/env bash

set -eo pipefail

################################################################################
# Validate Inputs
################################################################################

function usage {
    echo "usage: $0 [app] [environment] [namespace] [tag]"
    echo "  app          slug of the app (eg. broadband-plans)"
    echo "  environment  environment to deploy the application to (staging or production)"
    echo "  namespace    namespace to promote the image (eg. production / magenta)"
    echo "  tag          tag of the image to deploy (eg. abcdef0)"
    exit 1
}

[ -z "$4" ] && { usage; }

################################################################################
# Set Inputs
################################################################################

APP=$1
ENVIRONMENT=$2
NAMESPACE=$3
TAG=$4

################################################################################
# Set Variables
################################################################################

REPOSITORY="$ECR_ENDPOINT/$APP"

################################################################################
# Set migration properties
################################################################################

pushd k8s/pre-release
kustomize edit set image unset=$REPOSITORY:$TAG
popd

################################################################################
# Cleanup old migration jobs
################################################################################

if kubectl get jobs -n $NAMESPACE | grep -q $APP-migration; then
  kubectl delete job/$APP-migration -n $NAMESPACE
fi

################################################################################
# Run migration
################################################################################

kubectl apply -k k8s/pre-release -n $NAMESPACE
kubectl wait --for=condition=complete job/$APP-migration --timeout=15m -n $NAMESPACE

################################################################################
# Cleanup migration job
################################################################################
kubectl delete job/$APP-migration -n $NAMESPACE
