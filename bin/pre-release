#!/usr/bin/env bash

set -eo pipefail

################################################################################
# Validate Inputs
################################################################################

function usage {
    echo "usage: $0 [app] [environment] [namespace] [tag]"
    echo "  app          slug of the app (eg. broadband-plans)"
    echo "  environment  environment to deploy the application to (staging or production)"
    echo "  namespace    namespace to promote the image (eg. production / magenta)"
    echo "  tag          tag of the image to deploy (eg. abcdef0)"
    exit 1
}

[ -z "$4" ] && { usage; }

################################################################################
# Set Inputs
################################################################################

APP=$1
ENVIRONMENT=$2
NAMESPACE=$3
TAG=$4

################################################################################
# Constants
################################################################################

DIR="$(dirname "${BASH_SOURCE[0]}")"

################################################################################
# Execute Pre Release Scripts
################################################################################

[ ! -d k8s/pre-release ] && exit 0

"${DIR}/pre-release-scripts/db-migrate" "$APP" "$ENVIRONMENT" "$NAMESPACE" "$TAG"

if [ "$APP" == "cms" ]; then
  "${DIR}/pre-release-scripts/push-cms-assets" "$APP" "$ENVIRONMENT" "$NAMESPACE" "$TAG"
fi
